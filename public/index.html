<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœæ ¼æ²ƒèŒ¨ä¹‹æ—…</title>
    <style>
        /* --- éœæ ¼æ²ƒèŒ¨ä¸»é¢˜é£æ ¼ --- */
        :root {
            --hogwarts-purple: #7b2cbf;
            --hogwarts-gold: #ffc107;
            --hogwarts-red: #c62828;
            --background-dark: #263238;
            --card-light: #ffffff;
            --accent-blue: #2196F3;
        }

        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 30px;
            background: linear-gradient(135deg, var(--background-dark) 0%, #37474f 100%);
            color: #ccc;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--card-light);
            padding: 40px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            border: 3px solid var(--hogwarts-gold);
            color: #333;
        }

        h1 {
            color: var(--hogwarts-red);
            text-align: center;
            font-family: 'Times New Roman', Times, serif;
            font-size: 2.5em;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        h2 {
            color: var(--hogwarts-purple);
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-top: 25px;
        }

        /* --- èœå•å’ŒæŒ‰é’® --- */
        #level-list button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 12px;
            background-color: #eee;
            border: none;
            border-radius: 6px;
            text-align: left;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #level-list button:hover {
            background-color: #e0e0e0;
        }

        #level-list button.completed {
            background-color: #d4edda;
            border-left: 5px solid #4CAF50;
        }

        .level-content,
        .ai-section {
            padding: 20px;
            border: 1px dashed #aaa;
            border-radius: 8px;
            margin-top: 20px;
        }

        /* --- æœ—è¯»é¢˜æ ·å¼ --- */
        .prompt-read p {
            line-height: 1.8;
            font-size: 1.1em;
            background-color: #f7f7f7;
            padding: 15px;
            border-radius: 4px;
        }

        .controls button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #stopButton {
            background-color: var(--hogwarts-red);
        }

        /* --- é—®ç­”éƒ¨åˆ†æ ·å¼ (æ–°çš„) --- */
        #ai-output {
            margin-top: 15px;
            padding: 15px;
            background-color: #e3f2fd;
            border-left: 5px solid var(--accent-blue);
        }

        .check-button {
            background-color: var(--accent-blue);
        }

        .option-button.selected {
            border: 2px solid var(--hogwarts-purple);
            background-color: #f3e5f5;
        }

        /* ç»“æœæ¶ˆæ¯ */
        .result-message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            font-weight: bold;
        }

        .result-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .house-assignment {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 1.2em;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>éœæ ¼æ²ƒèŒ¨ä¹‹æ—…ï¼šè‹±è¯­é­”æ³•æŒ‘æˆ˜</h1>

        <div id="main-menu">
            <h2>ğŸ”® é­”æ³•è¯¾ç¨‹é€‰æ‹©</h2>
            <div id="house-display" class="house-assignment" style="display: none;"></div>
            <div id="level-list">
            </div>
        </div>

        <div class="ai-section">
            <h2>ğŸ“œ é­”æ³•ä¹¦æŸ¥è¯¢ (AI äº’åŠ¨æ›¿ä»£)</h2>
            <p>åœ¨è¿™é‡Œä½ å¯ä»¥å‘â€œé­”æ³•ä¹¦â€æé—®ä»»ä½•å…³äºå“ˆåˆ©æ³¢ç‰¹æˆ–è‹±è¯­å­¦ä¹ çš„é—®é¢˜ã€‚ (çº¯å‰ç«¯æ¨¡æ‹Ÿ)</p>
            <input type="text" id="ai-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šä»€ä¹ˆæ˜¯ 'Muggle'ï¼Ÿ"
                style="width: 70%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
            <button onclick="askMagicBook()" style="background-color: var(--accent-blue); color: white;">æŸ¥è¯¢</button>
            <div id="ai-output">ç­”æ¡ˆå°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</div>
        </div>

        <div id="level-display" class="level-content" style="display: none;">
            <h2></h2>
            <div id="current-prompt"></div>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. å…³å¡æ•°æ® (LEVELS) å’Œ å­¦é™¢æ•°æ® (HOUSES)
        // ----------------------------------------------------

        // --- æ ¸å¿ƒéŸ³é¢‘æ–‡ä»¶å’Œåç§° (Chapter 1 - 17) ---
        const AUDIO_BASE_PATH = 'audio/Harry Potter and the Philosopher\'s Stone/';

        const RAW_CHAPTERS = [
            { id: 1, file: '0002 - Chapter 1 - The Boy Who Lived.mp3', name: 'å†¥æƒ³å®¤ï¼šç¬¬ä¸€ç« ï¼šå¤§éš¾ä¸æ­»çš„ç”·å­©' },
            { id: 2, file: '0003 - Chapter 2 - The Vanishing Glass.mp3', name: 'é­”å’’è¯¾ï¼šç¬¬äºŒç« ï¼šæ¶ˆå¤±çš„ç»ç’ƒ' },
            { id: 3, file: '0004 - Chapter 3 - The Letters from No One.mp3', name: 'é˜²å¾¡æœ¯ï¼šç¬¬ä¸‰ç« ï¼šæ²¡äººå¯„æ¥çš„ä¿¡' },
            { id: 4, file: '0005 - Chapter 4 - The Keeper of the Keys.mp3', name: 'è‰è¯å­¦ï¼šç¬¬å››ç« ï¼šé’¥åŒ™çš„ä¿ç®¡å‘˜' },
            { id: 5, file: '0006 - Chapter 5 - Diagon Alley.mp3', name: 'ç®—æœ¯å åœï¼šç¬¬äº”ç« ï¼šå¯¹è§’å··' },
            { id: 6, file: '0007 - Chapter 6 - The Journey from Platform No.mp3', name: 'å¤©æ–‡è¯¾ï¼šç¬¬å…­ç« ï¼šä»ä¹åˆå››åˆ†ä¹‹ä¸‰ç«™å°å‡ºå‘' },
            { id: 7, file: '0008 - Chapter 7 - The Sorting Hat.mp3', name: 'é­”æ³•å²ï¼šç¬¬ä¸ƒç« ï¼šåˆ†é™¢å¸½' },
            { id: 8, file: '0009 - Chapter 8 - The Potions Master.mp3', name: 'é­”è¯å­¦ï¼šç¬¬å…«ç« ï¼šé­”è¯å¤§å¸ˆ' },
            { id: 9, file: '0010 - Chapter 9 - The Midnight Duel.mp3', name: 'å†³æ–—ä¿±ä¹éƒ¨ï¼šç¬¬ä¹ç« ï¼šåˆå¤œå†³æ–—' },
            { id: 10, file: '0011 - Chapter 10 - Hallowe\'en.mp3', name: 'éœæ ¼è«å¾·ï¼šç¬¬åç« ï¼šä¸‡åœ£èŠ‚' },
            { id: 11, file: '0012 - Chapter 11 - Quidditch.mp3', name: 'é­åœ°å¥‡è¯¾ï¼šç¬¬åä¸€ç« ï¼šé­åœ°å¥‡' },
            { id: 12, file: '0013 - Chapter 12 - The Mirror of Erised.mp3', name: 'å åœè¯¾ï¼šç¬¬åäºŒç« ï¼šå„é‡Œæ–¯é­”é•œ' },
            { id: 13, file: '0014 - Chapter 13 - Nicolas Flamel.mp3', name: 'ç‚¼é‡‘æœ¯ï¼šç¬¬åä¸‰ç« ï¼šå°¼å¤æ‹‰æ–¯Â·å¼—æ‹‰æ¢…å°”' },
            { id: 14, file: '0015 - Chapter 14 - Norbert the Norwegian Ridgeback.mp3', name: 'å¥‡å…½é¥²è‚²å­¦ï¼šç¬¬åå››ç« ï¼šæŒªå¨è„ŠèƒŒé¾™è¯ºä¼¯' },
            { id: 15, file: '0016 - Chapter 15 - The Forbidden Forest.mp3', name: 'ç¦æ—æ¢é™©ï¼šç¬¬åäº”ç« ï¼šç¦æ—' },
            { id: 16, file: '0017 - Chapter 16 - Through the Trapdoor.mp3', name: 'é™·é˜±æ¢ç§˜ï¼šç¬¬åå…­ç« ï¼šé€šè¿‡æ´»æ¿é—¨' },
            { id: 17, file: '0018 - Chapter 17 - The Man with Two Faces.mp3', name: 'æœ€ç»ˆè¯•ç‚¼ï¼šç¬¬åä¸ƒç« ï¼šåŒé¢äºº' }
        ];

        // --- æ ¸å¿ƒæœ—è¯»æ–‡æœ¬ (ç»Ÿä¸€ä½¿ç”¨ Chapter 1 å¼€å¤´æ®µè½ä½œä¸º Demo æ–‡æœ¬) ---
        const DEMO_PROMPT = "Mr. and Mrs. Dursley, of number four, Privet Drive, were proud to say that they were perfectly normal, thank you very much. They were the last people you'd expect to be involved in anything strange or mysterious, because they just didn't hold with such nonsense.";
        const DEMO_ANSWER = "mr. and mrs. dursley of number four privet drive were proud to say that they were perfectly normal thank you very much they were the last people you'd expect to be involved in anything strange or mysterious because they just didn't hold with such nonsense";

        // åŠ¨æ€ç”Ÿæˆ 17 ä¸ªæœ—è¯»å…³å¡
        const LEVELS = RAW_CHAPTERS.map(chapter => ({
            id: chapter.id,
            name: chapter.name,
            type: "READ", // æ‰€æœ‰å…³å¡ç»Ÿä¸€ä¸ºæœ—è¯»é¢˜
            audioFile: AUDIO_BASE_PATH + chapter.file, // å¼•ç”¨å¯¹åº”çš„éŸ³é¢‘
            prompt: DEMO_PROMPT, // ä½¿ç”¨ç»Ÿä¸€çš„æ¼”ç¤ºæ–‡æœ¬
            correct_answer: DEMO_ANSWER, // ä½¿ç”¨ç»Ÿä¸€çš„æ¼”ç¤ºç­”æ¡ˆ
            instructions: `è¯·å¬å– ${chapter.name} çš„éŸ³é¢‘ï¼Œå¹¶æœ—è¯»ä¸‹æ–¹è¿™æ®µè¯ï¼Œç³»ç»Ÿå°†è¿›è¡Œé€è¯å¯¹æ¯”ã€‚`
        }));

        // --- å­¦é™¢æ•°æ® ---
        const HOUSES = [
            { name: "Gryffindor (æ ¼å…°èŠ¬å¤š)", color: "#9C27B0", trait: "å‹‡æ•¢ã€å¤§èƒ†ã€æœ‰éª‘å£«ç²¾ç¥" },
            { name: "Hufflepuff (èµ«å¥‡å¸•å¥‡)", color: "#FFC107", trait: "å¿ è¯šã€è€å¿ƒã€å‹¤åŠ³" },
            { name: "Ravenclaw (æ‹‰æ–‡å…‹åŠ³)", color: "#2196F3", trait: "æ™ºæ…§ã€å­¦ä¹ ã€æœºæ™º" },
            { name: "Slytherin (æ–¯è±ç‰¹æ—)", color: "#4CAF50", trait: "é›„å¿ƒå£®å¿—ã€ç‹¡çŒ¾ã€æœæ–­" }
        ];

        // ç®€å•çš„ç”¨æˆ·çŠ¶æ€ï¼Œç”¨äºå­¦é™¢åˆ†é…
        let userPerformance = {
            accuracySum: 0,
            readLevelsCompleted: 0,
            quizScore: 0
        };

        // ----------------------------------------------------
        // 2. DOM å…ƒç´ å’ŒçŠ¶æ€å˜é‡
        // ----------------------------------------------------
        const levelListDiv = document.getElementById('level-list');
        const levelDisplayDiv = document.getElementById('level-display');
        const currentPromptDiv = document.getElementById('current-prompt');
        const mainMenuDiv = document.getElementById('main-menu');
        const aiInput = document.getElementById('ai-input');
        const aiOutput = document.getElementById('ai-output');
        const houseDisplayDiv = document.getElementById('house-display');

        let currentLevel = null;
        let recognition = null;
        let currentSelectedOption = null;

        // ----------------------------------------------------
        // 3. æ ¸å¿ƒåŠŸèƒ½ï¼šéŸ³é¢‘æ’­æ”¾å’Œæœ—è¯»è¯†åˆ« (çº¯å‰ç«¯)
        // ----------------------------------------------------

        // --- éŸ³é¢‘æ’­æ”¾æ ¸å¿ƒåŠŸèƒ½ ---
        function playLevelAudio(audioPath) {
            // æš‚åœå¯èƒ½æ­£åœ¨æ’­æ”¾çš„å…¶ä»–éŸ³é¢‘
            if (window.currentAudio) {
                window.currentAudio.pause();
            }

            const playButton = document.getElementById('playAudioButton');

            // åˆ›å»ºæ–°çš„ Audio å¯¹è±¡å¹¶æ’­æ”¾
            window.currentAudio = new Audio(audioPath);
            window.currentAudio.play()
                .then(() => {
                    if (playButton) {
                        playButton.textContent = 'ğŸ”Š æ­£åœ¨æ’­æ”¾...';
                        playButton.disabled = true;
                    }
                    window.currentAudio.onended = () => {
                        if (playButton) {
                            playButton.textContent = 'â–¶ï¸ æ’­æ”¾éŸ³é¢‘';
                            playButton.disabled = false;
                        }
                    };
                })
                .catch(e => {
                    console.error("æ’­æ”¾éŸ³é¢‘å¤±è´¥:", e);
                    alert(`éŸ³é¢‘æ–‡ä»¶ (${audioPath}) æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œåç§°æ˜¯å¦æ­£ç¡®ï¼é”™è¯¯: ${e.message}`);
                    if (playButton) {
                        playButton.textContent = 'âŒ æ’­æ”¾å¤±è´¥';
                        playButton.disabled = false;
                    }
                });
        }


        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    document.getElementById('status').textContent = 'çŠ¶æ€: ğŸ™ï¸ æ­£åœ¨å½•éŸ³... è¯·æœ—è¯»ï¼';
                    document.getElementById('startButton').disabled = true;
                    document.getElementById('stopButton').disabled = false;
                    currentPromptDiv.querySelector('#recognisedText').textContent = '';
                    currentPromptDiv.querySelector('#comparisonResult').innerHTML = '';
                    currentPromptDiv.querySelector('#readResult').innerHTML = '';
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('status').textContent = `çŠ¶æ€: âœ… è¯†åˆ«å®Œæˆã€‚`;
                    currentPromptDiv.querySelector('#recognisedText').textContent = 'è¯†åˆ«ç»“æœ: ' + transcript;

                    const originalTextCleaned = currentLevel.correct_answer;
                    compareAndDisplay(originalTextCleaned, transcript.toLowerCase());
                };

                recognition.onerror = (event) => {
                    document.getElementById('status').textContent = `çŠ¶æ€: âŒ è¯†åˆ«é”™è¯¯: ${event.error}`;
                    console.error('Recognition error: ' + event.error);
                    document.getElementById('startButton').disabled = false;
                    document.getElementById('stopButton').disabled = true;
                };

                recognition.onend = () => {
                    const statusDiv = document.getElementById('status');
                    if (statusDiv.textContent.includes('ğŸ™ï¸')) {
                        statusDiv.textContent = 'çŠ¶æ€: åœæ­¢å½•éŸ³ã€‚';
                    }
                    if (document.getElementById('startButton')) {
                        document.getElementById('startButton').disabled = false;
                    }
                    if (document.getElementById('stopButton')) {
                        document.getElementById('stopButton').disabled = true;
                    }
                };

            } else {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Web Speech APIã€‚è¯·ä½¿ç”¨ Chrome æµè§ˆå™¨ä½“éªŒæœ—è¯»åŠŸèƒ½ã€‚');
            }
        }

        // æ ¸å¿ƒå¯¹æ¯”å‡½æ•°ï¼šçªå‡ºæ˜¾ç¤ºåŒ¹é…/ä¸åŒ¹é…çš„å•è¯
        function compareAndDisplay(original, recognised) {
            const originalWords = original.split(/\s+/).filter(w => w.length > 0);
            const recognisedWords = recognised.split(/\s+/).filter(w => w.length > 0);

            let htmlOutput = '';
            let originalIndex = 0;
            let recognisedIndex = 0;
            let matchCount = 0;

            // é€è¯å¯¹æ¯”é€»è¾‘ (ç®€åŒ–çš„ LCS)
            while (originalIndex < originalWords.length) {
                const originalWord = originalWords[originalIndex];

                if (recognisedIndex < recognisedWords.length && originalWord === recognisedWords[recognisedIndex]) {
                    htmlOutput += `<span style="color: green; font-weight: bold;">${originalWord}</span> `;
                    originalIndex++;
                    recognisedIndex++;
                    matchCount++;
                } else {
                    htmlOutput += `<span style="color: red; text-decoration: underline;">${originalWord}</span> `;
                    originalIndex++;

                    // å°è¯•åœ¨è¯†åˆ«ç»“æœä¸­æ‰¾åˆ°ä¸‹ä¸€ä¸ªåŒ¹é…é¡¹ä»¥åŒæ­¥
                    let foundNext = false;
                    for (let i = recognisedIndex + 1; i < recognisedWords.length; i++) {
                        if (originalIndex < originalWords.length && originalWords[originalIndex] === recognisedWords[i]) {
                            recognisedIndex = i;
                            foundNext = true;
                            break;
                        }
                    }
                    if (!foundNext) {
                        recognisedIndex++;
                    }
                }
            }

            const totalWords = originalWords.length;
            const accuracy = Math.round((matchCount / totalWords) * 100);
            userPerformance.accuracySum += accuracy;
            userPerformance.readLevelsCompleted++;

            const comparisonResultDiv = currentPromptDiv.querySelector('#comparisonResult');

            comparisonResultDiv.innerHTML = `
                <h3>å¯¹æ¯”ç»“æœ:</h3>
                <p><strong>æœ—è¯»åŒ¹é…ç‡: ${accuracy}%</strong></p>
                <p>${htmlOutput}</p>
                <p style="margin-top: 15px;">ï¼ˆ<span style="color: green; font-weight: bold;">ç»¿è‰²ç²—ä½“</span>: åŒ¹é…æˆåŠŸ, <span style="color: red; text-decoration: underline;">çº¢è‰²ä¸‹åˆ’çº¿</span>: æœªåŒ¹é…æˆ–é”™è¯¯ï¼‰</p>
            `;

            if (accuracy >= 80) {
                displayReadResult(true, 'å¤ªæ£’äº†ï¼ä½ çš„æœ—è¯»éå¸¸å‡†ç¡®ï¼Œå…³å¡é€šè¿‡ï¼');
                markLevelCompleted(currentLevel.id);
            } else {
                displayReadResult(false, 'æœ—è¯»åŒ¹é…ç‡ä¸è¶³ 80%ï¼Œè¯·å†æ¥å†å‰ï¼');
            }
        }

        // ----------------------------------------------------
        // 4. ç•Œé¢æ¸²æŸ“å’Œé€»è¾‘
        // ----------------------------------------------------

        // é­”æ³•ä¹¦æŸ¥è¯¢ (AI äº’åŠ¨æ›¿ä»£)
        function askMagicBook() {
            const question = aiInput.value.trim().toLowerCase();
            aiOutput.innerHTML = '';

            if (!question) {
                aiOutput.innerHTML = `<p style="color: var(--hogwarts-red);">è¯·é—®ä¸€ä¸ªé—®é¢˜ï¼</p>`;
                return;
            }

            let answer = '';
            if (question.includes('muggle') || question.includes('éº»ç“œ')) {
                answer = 'æ ¹æ®é­”æ³•ä¹¦è®°å½•ï¼Œ"Muggle" (éº»ç“œ) æ˜¯æŒ‡ä¸å…·å¤‡ä»»ä½•é­”æ³•èƒ½åŠ›çš„æ™®é€šäººã€‚';
            } else if (question.includes('dursley')) {
                answer = 'Dursley ä¸€å®¶æ˜¯ Harry Potter çš„éº»ç“œäº²æˆšï¼Œä»–ä»¬å¯¹é­”æ³•æ€€æœ‰å¼ºçƒˆçš„åŒæ¶ã€‚';
            } else if (question.includes('leviosa') || question.includes('æ‚¬æµ®')) {